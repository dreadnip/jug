#!/usr/bin/env php
<?php

declare(strict_types=1);

require __DIR__ . '/../autoload.php';

use App\Command\BuildSiteCommand;
use Symfony\Bridge\Twig\Extension\TranslationExtension;
use Symfony\Component\Console\Application;
use Symfony\Component\Filesystem\Filesystem;
use Symfony\Component\Translation\Loader\YamlFileLoader;
use Symfony\Component\Translation\Translator;
use Twig\Environment;
use Twig\Loader\FilesystemLoader;

$application = new Application();
$fileSystem = new Filesystem();

if (!$fileSystem->exists('source') ||
    !$fileSystem->exists('source/_includes') ||
    !$fileSystem->exists('source/_layouts')) {
    throw new RuntimeException('Invalid project structure.');
}

// Load config
$config = require 'config/jug.php';

// Build Translator dependency
$translator = new Translator($config['default_locale']);
foreach ($config['locales'] as $locale) {
    $translator->addLoader('yaml', new YamlFileLoader());
    $translator->addResource('yaml', 'translations/messages.' . $locale . '.yaml', $locale);
}

// Build Twig dependency
$loader = new FilesystemLoader(['source', 'source/_includes', 'source/_layouts']);
$twig = new Environment($loader);
foreach ($config['globals'] as $key => $value) {
    $twig->addGlobal($key, $value);
}
$twig->addExtension(new TranslationExtension($translator));

// Register our command
$application->add(new BuildSiteCommand($twig));

$application->run();