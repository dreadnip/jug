#!/usr/bin/env php
<?php

declare(strict_types=1);

require __DIR__ . '/../../autoload.php';

use Jug\Command\WatchCommand;
use Jug\Twig\AssetExtension;
use Jug\Twig\FolderExtension;
use Jug\Twig\HighlightExtension;
use Jug\Command\BuildCommand;
use Jug\Config\Config;
use Jug\Twig\MarkdownExtension;
use Jug\Twig\SqliteExtension;
use Michelf\Markdown;
use Symfony\Bridge\Twig\Extension\TranslationExtension;
use Symfony\Component\Console\Application;
use Symfony\Component\Filesystem\Filesystem;
use Symfony\Component\Translation\Loader\YamlFileLoader;
use Symfony\Component\Translation\Translator;
use Twig\Environment;
use Jug\Twig\DynamicFilesystemLoader;

$application = new Application();
$filesystem = new Filesystem();

if (!$filesystem->exists('source') ||
    !$filesystem->exists('source/_includes') ||
    !$filesystem->exists('source/_layouts')) {
    throw new RuntimeException('Invalid project structure.');
}

// Config
if (!is_file('config/jug.php')) {
    throw new RuntimeException('Missing required config file: config/jug.php');
}

$config = require 'config/jug.php';
$config = new Config($config);

// Twig
$loader = new DynamicFilesystemLoader(['source', 'source/_includes', 'source/_layouts']);
$twig = new Environment($loader, [
    'auto_reload' => true
]);

foreach ($config->getAll() as $key => $value) {
    $twig->addGlobal($key, $value);
}

// Translations
if (!$config->has('default_locale')) {
    throw new RuntimeException('Missing required config option: default_locale.');
}

$translator = new Translator($config->getString('default_locale'));
$translator->addLoader('yaml', new YamlFileLoader());

if ($config->has('locales')) {
    foreach ($config->getArray('locales') as $locale) {
        $translationPath ='translations/messages.' . $locale . '.yaml';

        if (is_file($translationPath)) {
            $translator->addResource('yaml', $translationPath, $locale);
        }
    }
} else {
    $translationPath = 'translations/messages.' . $config->get('default_locale') . '.yaml';

    if (is_file($translationPath)) {
        $translator->addResource('yaml', $translationPath, $config->getString('default_locale'));
    }
}

$twig->addExtension(new TranslationExtension($translator));
$twig->addExtension(new AssetExtension($config));
$twig->addExtension(new MarkdownExtension(new Markdown()));
$twig->addExtension(new HighlightExtension());
$twig->addExtension(new SqliteExtension());
$twig->addExtension(new FolderExtension());

// Register our commands
$application->add(new BuildCommand($twig, $filesystem, $config));
$application->add(new WatchCommand());

$application->run();